ARG BASE_IMAGE=centos:7

FROM $BASE_IMAGE as sag_base

ENV SAG_HOME=/opt/softwareag

RUN yum -y update &&\
	yum -y clean all &&\
	groupadd -g 1724 sagadmin &&\
	useradd -u 1724 -m -g 1724 -d $SAG_HOME -c "SoftwareAG Admin" sagadmin &&\
	mkdir -p $SAG_HOME && chown 1724:1724 $SAG_HOME &&\
	chmod 775 $SAG_HOME &&\
	mkdir -p $SAG_HOME/jvm &&\
	chown 1724:1724 $SAG_HOME/jvm

COPY --chown=1724:1724 ./SAG_HOME/jvm/jvm/ $SAG_HOME/jvm/jvm/

ENV PATH=$SAG_HOME:$SAG_HOME/jvm/jvm:$PATH

USER 1724

FROM sag_base

# __instance_name: If user want to copy the specific instance content to image, they can specifiy here. Default instance name is 'umserver'
ARG __instance_name=umserver

MAINTAINER Myhael76
# Adapted from Software AG

# Environment variables
ENV INSTANCE_NAME=$__instance_name

# Environment variables
ENV	UM_HOME=$SAG_HOME/UniversalMessaging
ENV PORT=9000 \
	DATA_DIR=$UM_HOME/server/$INSTANCE_NAME/data \
    USERS_DIR=$SAG_HOME/common/conf \
    SERVER_COMMON_CONF_FILE=Server_Common.conf \
    TOOLS_DIR=$UM_HOME/tools

# Create the required folders (data, logs, licence and tools) as these are not going to be copied from the installation, but will be needed at runtime
RUN mkdir -p $SAG_HOME/common $DATA_DIR $LOG_DIR $LIC_DIR $TOOLS_DIR $DATA_DIR/heap_dumps &&\
	chown 1724:1724 $DATA_DIR &&\
	chown 1724:1724 $LOG_DIR &&\
	chown 1724:1724 $LIC_DIR &&\
	chown 1724:1724 $TOOLS_DIR &&\
	chown 1724:1724 $DATA_DIR/heap_dumps &&\
	chown 1724:1724 $SAG_HOME/common

# Copy the required binaries from installation to image

#### Try to optimize upfront...
COPY --chown=1724:1724 ./SAG_HOME/ $SAG_HOME/
#COPY --chown=1724:1724 ./common/bin/ $SAG_HOME/common/bin/
#COPY --chown=1724:1724 ./common/lib/ $SAG_HOME/common/lib/
#COPY --chown=1724:1724 ./common/metering/ $SAG_HOME/common/metering/
#COPY --chown=1724:1724 ./common/conf/users.txt $USERS_DIR/users.txt
#COPY --chown=1724:1724 ./UniversalMessaging/server/$INSTANCE_NAME/bin $UM_HOME/server/$INSTANCE_NAME/bin
#COPY --chown=1724:1724 ./UniversalMessaging/lib/ $UM_HOME/lib/
#COPY --chown=1724:1724 ./UniversalMessaging/classes/ $UM_HOME/classes/
#COPY --chown=1724:1724 ./UniversalMessaging/tools/runner/ $TOOLS_DIR/runner/

# Move the licence file to Universal Messaging licence folder
# COPY --chown=1724:1724 ./UniversalMessaging/server/$INSTANCE_NAME/licence.xml $LIC_DIR/licence.xml
######## Correction: expect license file to be mounted

# Copy the configure.sh which contains all the build time configuration changes
#COPY --chown=1724:1724 ./configure.sh $SAG_HOME/configure.sh


# Change the permissions to configure.sh and run it
#RUN chmod u+x $SAG_HOME/configure.sh ;\
#	$SAG_HOME/configure.sh

# Add the runUMTool path, so we can run this tool directly from docker exec command
ENV PATH=$TOOLS_DIR/runner/:$PATH

# Create the Persistent storage for data directory, logs directory, licence directory and users directory
# VOLUME [ "$DATA_DIR", "$LOG_DIR", "$LIC_DIR", "$USERS_DIR" ]

# Change the work directory, where the entry point script is present.
WORKDIR $SAG_HOME
#ENTRYPOINT umstart.sh

#HEALTHCHECK --interval=15s --timeout=30s --start-period=120s  CMD $UM_HOME/tools/runner/runUMTool.sh GetServerTime -rname=nsp://localhost:$PORT || exit 1

#EXPOSE $PORT